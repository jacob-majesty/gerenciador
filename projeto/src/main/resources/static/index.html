<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Portfólio de Projetos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        .container {
            @apply max-w-7xl mx-auto p-4;
        }
        .card {
            @apply bg-white rounded-lg shadow-md p-6 mb-6;
        }
        .form-input {
            @apply block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm;
        }
        .btn {
            @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-500;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700 focus:ring-green-500;
        }
        .table-header {
            @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .table-cell {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
        }
        .modal {
            @apply fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-xl p-6 w-full max-w-lg;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-3xl font-bold text-center my-8 text-blue-700">Gerenciador de Portfólio de Projetos</h1>

    <!-- Seção de Login -->
    <div id="login-section" class="card max-w-md mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Usuário:</label>
                <input type="text" id="username" name="username" class="form-input mt-1" value="user" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Senha:</label>
                <input type="password" id="password" name="password" class="form-input mt-1" value="password123" required>
            </div>
            <button type="submit" class="btn btn-primary w-full">Entrar</button>
            <p id="login-error" class="text-red-600 text-center mt-2 hidden">Usuário ou senha inválidos.</p>
        </form>
    </div>

    <!-- Conteúdo Principal da Aplicação (escondido até o login) -->
    <div id="app-content" class="hidden">
        <!-- Formulário de Criação de Projeto -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 text-blue-600">Criar Novo Projeto</h2>
            <form id="create-project-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="projectName" class="block text-sm font-medium text-gray-700">Nome do Projeto:</label>
                    <input type="text" id="projectName" name="name" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700">Data de Início:</label>
                    <input type="date" id="startDate" name="startDate" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="forecastEndDate" class="block text-sm font-medium text-gray-700">Previsão de Término:</label>
                    <input type="date" id="forecastEndDate" name="forecastEndDate" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="actualEndDate" class="block text-sm font-medium text-gray-700">Data Real de Término (Opcional):</label>
                    <input type="date" id="actualEndDate" name="actualEndDate" class="form-input mt-1">
                </div>
                <div>
                    <label for="totalBudget" class="block text-sm font-medium text-gray-700">Orçamento Total:</label>
                    <input type="number" step="0.01" id="totalBudget" name="totalBudget" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="managerId" class="block text-sm font-medium text-gray-700">ID do Gerente:</label>
                    <input type="number" id="managerId" name="managerId" class="form-input mt-1" required>
                </div>
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição:</label>
                    <textarea id="description" name="description" rows="3" class="form-input mt-1"></textarea>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Status Inicial:</label>
                    <select id="status" name="status" class="form-input mt-1" required>
                        <option value="EM_ANALISE">Em Análise</option>
                        <option value="ANALISE_REALIZADA">Análise Realizada</option>
                        <option value="ANALISE_APROVADA">Análise Aprovada</option>
                        <option value="INICIADO">Iniciado</option>
                        <option value="PLANEJADO">Planejado</option>
                        <option value="EM_ANDAMENTO">Em Andamento</option>
                        <option value="ENCERRADO">Encerrado</option>
                        <option value="CANCELADO">Cancelado</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn btn-primary">Criar Projeto</button>
                </div>
            </form>
            <p id="create-project-message" class="mt-4 text-center"></p>
        </div>

        <!-- Listagem de Projetos -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 text-blue-600">Projetos Existentes</h2>

            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="filterName" class="block text-sm font-medium text-gray-700">Filtrar por Nome:</label>
                    <input type="text" id="filterName" class="form-input mt-1">
                </div>
                <div>
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700">Filtrar por Status:</label>
                    <select id="filterStatus" class="form-input mt-1">
                        <option value="">Todos</option>
                        <option value="EM_ANALISE">Em Análise</option>
                        <option value="ANALISE_REALIZADA">Análise Realizada</option>
                        <option value="ANALISE_APROVADA">Análise Aprovada</option>
                        <option value="INICIADO">Iniciado</option>
                        <option value="PLANEJADO">Planejado</option>
                        <option value="EM_ANDAMENTO">Em Andamento</option>
                        <option value="ENCERRADO">Encerrado</option>
                        <option value="CANCELADO">Cancelado</option>
                    </select>
                </div>
                <div>
                    <label for="filterManagerId" class="block text-sm font-medium text-gray-700">Filtrar por ID Gerente:</label>
                    <input type="number" id="filterManagerId" class="form-input mt-1">
                </div>
                <div class="md:col-span-3 flex justify-end">
                    <button id="applyFiltersBtn" class="btn btn-secondary">Aplicar Filtros</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="table-header">ID</th>
                        <th class="table-header">Nome</th>
                        <th class="table-header">Gerente</th>
                        <th class="table-header">Status</th>
                        <th class="table-header">Orçamento</th>
                        <th class="table-header">Risco</th>
                        <th class="table-header">Ações</th>
                    </tr>
                    </thead>
                    <tbody id="projectsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Projetos serão carregados aqui pelo JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-between items-center mt-4">
                <button id="prevPageBtn" class="btn btn-secondary" disabled>Anterior</button>
                <span id="pageInfo" class="text-sm text-gray-700">Página 1 de 1</span>
                <button id="nextPageBtn" class="btn btn-secondary" disabled>Próxima</button>
            </div>
            <p id="list-projects-message" class="mt-4 text-center"></p>
        </div>
    </div>

    <!-- Modal de Atualização de Status -->
    <div id="statusModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Atualizar Status do Projeto</h3>
            <input type="hidden" id="modalProjectId">
            <p class="mb-2">Projeto: <span id="modalProjectName" class="font-medium"></span></p>
            <p class="mb-4">Status Atual: <span id="modalCurrentStatus" class="font-medium"></span></p>
            <div>
                <label for="newStatus" class="block text-sm font-medium text-gray-700">Novo Status:</label>
                <select id="newStatus" class="form-input mt-1" required>
                    <option value="EM_ANALISE">Em Análise</option>
                    <option value="ANALISE_REALIZADA">Análise Realizada</option>
                    <option value="ANALISE_APROVADA">Análise Aprovada</option>
                    <option value="INICIADO">Iniciado</option>
                    <option value="PLANEJADO">Planejado</option>
                    <option value="EM_ANDAMENTO">Em Andamento</option>
                    <option value="ENCERRADO">Encerrado</option>
                    <option value="CANCELADO">Cancelado</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancelStatusUpdateBtn" class="btn btn-secondary">Cancelar</button>
                <button id="saveStatusUpdateBtn" class="btn btn-primary">Salvar</button>
            </div>
            <p id="status-update-message" class="mt-4 text-center"></p>
        </div>
    </div>

    <!-- Modal de Alocação de Membros -->
    <div id="allocateMembersModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Alocar Membros ao Projeto</h3>
            <input type="hidden" id="allocateModalProjectId">
            <p class="mb-2">Projeto: <span id="allocateModalProjectName" class="font-medium"></span></p>
            <div class="mb-4">
                <label for="memberIdsInput" class="block text-sm font-medium text-gray-700">IDs dos Membros (separados por vírgula):</label>
                <input type="text" id="memberIdsInput" class="form-input mt-1" placeholder="Ex: 101, 102, 103">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancelAllocateMembersBtn" class="btn btn-secondary">Cancelar</button>
                <button id="saveAllocateMembersBtn" class="btn btn-primary">Alocar</button>
            </div>
            <p id="allocate-members-message" class="mt-4 text-center"></p>
        </div>
    </div>

    <!-- Modal de Listagem de Membros Alocados -->
    <div id="listMembersModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Membros Alocados no Projeto</h3>
            <p class="mb-2">Projeto: <span id="listMembersModalProjectName" class="font-medium"></span></p>
            <ul id="allocatedMembersList" class="list-disc pl-5 mb-4">
                <!-- Membros serão listados aqui -->
            </ul>
            <div class="flex justify-end mt-6">
                <button id="closeListMembersModalBtn" class="btn btn-secondary">Fechar</button>
            </div>
            <p id="list-members-message" class="mt-4 text-center"></p>
        </div>
    </div>

</div> <!-- Fim do container -->

<script>
    const API_BASE_URL = 'http://localhost:8085/api/projetos'; // Ajuste a porta se necessário
    const REPORT_API_URL = 'http://localhost:8085/api/relatorios/resumo'; // A porta será a mesma
    let username = '';
    let password = '';
    let currentPage = 0;
    const pageSize = 10; // Tamanho da página para listagem

    // Elementos do DOM
    const loginSection = document.getElementById('login-section');
    const appContent = document.getElementById('app-content');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const createProjectForm = document.getElementById('create-project-form');
    const createProjectMessage = document.getElementById('create-project-message');
    const projectsTableBody = document.getElementById('projectsTableBody');
    const listProjectsMessage = document.getElementById('list-projects-message');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');

    // Modais de Status
    const statusModal = document.getElementById('statusModal');
    const modalProjectId = document.getElementById('modalProjectId');
    const modalProjectName = document.getElementById('modalProjectName');
    const modalCurrentStatus = document.getElementById('modalCurrentStatus');
    const newStatusSelect = document.getElementById('newStatus');
    const cancelStatusUpdateBtn = document.getElementById('cancelStatusUpdateBtn');
    const saveStatusUpdateBtn = document.getElementById('saveStatusUpdateBtn');
    const statusUpdateMessage = document.getElementById('status-update-message');

    // Modais de Alocação de Membros
    const allocateMembersModal = document.getElementById('allocateMembersModal');
    const allocateModalProjectId = document.getElementById('allocateModalProjectId');
    const allocateModalProjectName = document.getElementById('allocateModalProjectName');
    const memberIdsInput = document.getElementById('memberIdsInput');
    const cancelAllocateMembersBtn = document.getElementById('cancelAllocateMembersBtn');
    const saveAllocateMembersBtn = document.getElementById('saveAllocateMembersBtn');
    const allocateMembersMessage = document.getElementById('allocate-members-message');

    // Modal de Listagem de Membros Alocados
    const listMembersModal = document.getElementById('listMembersModal');
    const listMembersModalProjectName = document.getElementById('listMembersModalProjectName');
    const allocatedMembersList = document.getElementById('allocatedMembersList');
    const closeListMembersModalBtn = document.getElementById('closeListMembersModalBtn');
    const listMembersMessage = document.getElementById('list-members-message');


    // --- Funções de Autenticação ---

    // Função auxiliar para fazer requisições autenticadas
    async function authenticatedFetch(url, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(username + ':' + password),
            ...options.headers
        };
        const response = await fetch(url, { ...options, headers });

        // Se a resposta for 401, significa que a autenticação falhou.
        // Redireciona para a tela de login.
        if (response.status === 401) {
            showLoginScreen('Sessão expirada ou credenciais inválidas. Por favor, faça login novamente.');
            throw new Error("Não autorizado. Redirecionando para o login.");
        }

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || `Erro na requisição: ${response.status}`);
        }
        return response;
    }

    // Exibe a tela de login e esconde o conteúdo da aplicação
    function showLoginScreen(message = '') {
        appContent.classList.add('hidden');
        loginSection.classList.remove('hidden');
        loginError.textContent = message;
        loginError.classList.remove('hidden');
        // Opcional: Limpar campos de usuário/senha ou credenciais armazenadas
        username = '';
        password = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    // Lida com o envio do formulário de login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        username = document.getElementById('username').value;
        password = document.getElementById('password').value;
        loginError.classList.add('hidden'); // Esconde erros anteriores

        try {
            // Tenta fazer uma requisição simples para validar as credenciais
            // Usamos o endpoint de listagem de projetos, que é protegido.
            const testResponse = await authenticatedFetch(`${API_BASE_URL}?page=0&size=1`);
            if (testResponse.ok) {
                loginSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                await fetchProjects(); // Carrega os projetos após o login bem-sucedido
            } else {
                // Isso não deve acontecer se authenticatedFetch já trata 401, mas é um fallback
                loginError.textContent = 'Usuário ou senha inválidos.';
                loginError.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Erro durante o login de teste:", error);
            // A mensagem de erro já será definida por authenticatedFetch se for 401
            if (!loginError.classList.contains('hidden')) { // Se já mostrou erro de 401
                loginError.textContent = 'Falha no login. Verifique suas credenciais.';
            } else { // Se for outro tipo de erro
                loginError.textContent = `Erro ao tentar login: ${error.message}`;
            }
            loginError.classList.remove('hidden');
        }
    });

    // --- Funções de API ---

    // Criar Projeto
    createProjectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        createProjectMessage.textContent = '';
        createProjectMessage.classList.remove('text-green-600', 'text-red-600');

        const formData = new FormData(createProjectForm);
        const projectData = Object.fromEntries(formData.entries());

        // Formata as datas para dd/MM/yyyy
        if (projectData.startDate) projectData.startDate = formatDate(projectData.startDate);
        if (projectData.forecastEndDate) projectData.forecastEndDate = formatDate(projectData.forecastEndDate);
        if (projectData.actualEndDate) projectData.actualEndDate = formatDate(projectData.actualEndDate);

        // Converte orçamento e managerId para números
        projectData.totalBudget = parseFloat(projectData.totalBudget);
        projectData.managerId = parseInt(projectData.managerId);

        try {
            const response = await authenticatedFetch(API_BASE_URL, {
                method: 'POST',
                body: JSON.stringify(projectData)
            });
            const newProject = await response.json();
            createProjectMessage.textContent = `Projeto "${newProject.name}" criado com sucesso!`;
            createProjectMessage.classList.add('text-green-600');
            createProjectForm.reset(); // Limpa o formulário
            await fetchProjects(); // Recarrega a lista de projetos
        } catch (error) {
            createProjectMessage.textContent = `Erro ao criar projeto: ${error.message}`;
            createProjectMessage.classList.add('text-red-600');
        }
    });

    // Listar Projetos
    async function fetchProjects() {
        listProjectsMessage.textContent = 'Carregando projetos...';
        listProjectsMessage.classList.remove('text-green-600', 'text-red-600');
        projectsTableBody.innerHTML = ''; // Limpa a tabela

        const name = document.getElementById('filterName').value;
        const status = document.getElementById('filterStatus').value;
        const managerId = document.getElementById('filterManagerId').value;

        let url = `${API_BASE_URL}?page=${currentPage}&size=${pageSize}`;
        if (name) url += `&name=${encodeURIComponent(name)}`;
        if (status) url += `&status=${encodeURIComponent(status)}`;
        if (managerId) url += `&managerId=${encodeURIComponent(managerId)}`;

        try {
            const response = await authenticatedFetch(url);
            const data = await response.json();

            if (data.content && data.content.length > 0) {
                data.content.forEach(project => {
                    const row = projectsTableBody.insertRow();
                    row.innerHTML = `
                            <td class="table-cell">${project.id}</td>
                            <td class="table-cell">${project.name}</td>
                            <td class="table-cell">${project.managerName || 'N/A'} (ID: ${project.managerId})</td>
                            <td class="table-cell">${project.status ? project.status.description : 'N/A'}</td>
                            <td class="table-cell">R$ ${project.totalBudget ? project.totalBudget.toFixed(2) : '0.00'}</td>
                            <td class="table-cell">${project.riskLevel ? project.riskLevel.description : 'N/A'}</td>
                            <td class="table-cell">
                                <button data-id="${project.id}" data-name="${project.name}" data-status="${project.status ? project.status.name : ''}" class="btn btn-secondary btn-sm mr-2 update-status-btn">Status</button>
                                <button data-id="${project.id}" data-name="${project.name}" class="btn btn-success btn-sm mr-2 allocate-members-btn">Alocar</button>
                                <button data-id="${project.id}" data-name="${project.name}" class="btn btn-secondary btn-sm mr-2 list-members-btn">Membros</button>
                                <button data-id="${project.id}" class="btn btn-danger btn-sm delete-project-btn">Excluir</button>
                            </td>
                        `;
                });
                listProjectsMessage.textContent = ''; // Limpa mensagem de carregamento
            } else {
                projectsTableBody.innerHTML = `<tr><td colspan="7" class="table-cell text-center text-gray-500">Nenhum projeto encontrado.</td></tr>`;
                listProjectsMessage.textContent = '';
            }

            // Atualiza info de paginação
            pageInfo.textContent = `Página ${data.number + 1} de ${data.totalPages}`;
            prevPageBtn.disabled = data.first;
            nextPageBtn.disabled = data.last;

        } catch (error) {
            listProjectsMessage.textContent = `Erro ao carregar projetos: ${error.message}`;
            listProjectsMessage.classList.add('text-red-600');
        }
    }

    // Event Listeners para Paginação e Filtros
    prevPageBtn.addEventListener('click', async () => {
        if (currentPage > 0) {
            currentPage--;
            await fetchProjects();
        }
    });

    nextPageBtn.addEventListener('click', async () => {
        currentPage++;
        await fetchProjects();
    });

    applyFiltersBtn.addEventListener('click', async () => {
        currentPage = 0; // Resetar para a primeira página ao aplicar filtros
        await fetchProjects();
    });

    // --- Funções para Modais ---

    // Abrir Modal de Status
    projectsTableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('update-status-btn')) {
            const projectId = e.target.dataset.id;
            const projectName = e.target.dataset.name;
            const currentStatus = e.target.dataset.status;

            modalProjectId.value = projectId;
            modalProjectName.textContent = projectName;
            modalCurrentStatus.textContent = currentStatus.replace(/_/g, ' '); // Formata para exibição
            newStatusSelect.value = currentStatus; // Seleciona o status atual no dropdown
            statusUpdateMessage.textContent = ''; // Limpa mensagens anteriores
            statusUpdateMessage.classList.remove('text-green-600', 'text-red-600');
            statusModal.classList.remove('hidden');
        }
    });

    // Fechar Modal de Status
    cancelStatusUpdateBtn.addEventListener('click', () => {
        statusModal.classList.add('hidden');
    });

    // Salvar Atualização de Status
    saveStatusUpdateBtn.addEventListener('click', async () => {
        const projectId = modalProjectId.value;
        const newStatus = newStatusSelect.value;
        statusUpdateMessage.textContent = '';
        statusUpdateMessage.classList.remove('text-green-600', 'text-red-600');

        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/${projectId}/status`, {
                method: 'PATCH',
                body: JSON.stringify({ newStatus: newStatus })
            });
            const updatedProject = await response.json();
            statusUpdateMessage.textContent = `Status do projeto "${updatedProject.name}" atualizado para "${updatedProject.status.description}"!`;
            statusUpdateMessage.classList.add('text-green-600');
            await fetchProjects(); // Recarrega a lista
            setTimeout(() => statusModal.classList.add('hidden'), 1500); // Fecha após um tempo
        } catch (error) {
            statusUpdateMessage.textContent = `Erro ao atualizar status: ${error.message}`;
            statusUpdateMessage.classList.add('text-red-600');
        }
    });

    // Excluir Projeto
    projectsTableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-project-btn')) {
            const projectId = e.target.dataset.id;
            if (confirm(`Tem certeza que deseja excluir o projeto ID ${projectId}?`)) {
                try {
                    await authenticatedFetch(`${API_BASE_URL}/${projectId}`, {
                        method: 'DELETE'
                    });
                    listProjectsMessage.textContent = `Projeto ID ${projectId} excluído com sucesso!`;
                    listProjectsMessage.classList.add('text-green-600');
                    await fetchProjects(); // Recarrega a lista
                } catch (error) {
                    listProjectsMessage.textContent = `Erro ao excluir projeto: ${error.message}`;
                    listProjectsMessage.classList.add('text-red-600');
                }
            }
        }
    });

    // Abrir Modal de Alocação de Membros
    projectsTableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('allocate-members-btn')) {
            const projectId = e.target.dataset.id;
            const projectName = e.target.dataset.name;

            allocateModalProjectId.value = projectId;
            allocateModalProjectName.textContent = projectName;
            memberIdsInput.value = ''; // Limpa o input
            allocateMembersMessage.textContent = ''; // Limpa mensagens anteriores
            allocateMembersMessage.classList.remove('text-green-600', 'text-red-600');
            allocateMembersModal.classList.remove('hidden');
        }
    });

    // Fechar Modal de Alocação de Membros
    cancelAllocateMembersBtn.addEventListener('click', () => {
        allocateMembersModal.classList.add('hidden');
    });

    // Salvar Alocação de Membros
    saveAllocateMembersBtn.addEventListener('click', async () => {
        const projectId = allocateModalProjectId.value;
        const memberIdsText = memberIdsInput.value;
        const memberIds = memberIdsText.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));

        allocateMembersMessage.textContent = '';
        allocateMembersMessage.classList.remove('text-green-600', 'text-red-600');

        if (memberIds.length === 0) {
            allocateMembersMessage.textContent = 'Por favor, insira IDs de membros válidos.';
            allocateMembersMessage.classList.add('text-red-600');
            return;
        }

        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/${projectId}/membros`, {
                method: 'POST',
                body: JSON.stringify(memberIds)
            });
            const updatedProject = await response.json();
            allocateMembersMessage.textContent = `Membros alocados ao projeto "${updatedProject.name}" com sucesso!`;
            allocateMembersMessage.classList.add('text-green-600');
            await fetchProjects(); // Recarrega a lista
            setTimeout(() => allocateMembersModal.classList.add('hidden'), 1500);
        } catch (error) {
            allocateMembersMessage.textContent = `Erro ao alocar membros: ${error.message}`;
            allocateMembersMessage.classList.add('text-red-600');
        }
    });

    // Abrir Modal de Listagem de Membros Alocados
    projectsTableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('list-members-btn')) {
            const projectId = e.target.dataset.id;
            const projectName = e.target.dataset.name;

            listMembersModalProjectId.value = projectId; // Guardar o ID do projeto no modal
            listMembersModalProjectName.textContent = projectName;
            allocatedMembersList.innerHTML = ''; // Limpa a lista
            listMembersMessage.textContent = 'Carregando membros...';
            listMembersMessage.classList.remove('text-green-600', 'text-red-600');
            listMembersModal.classList.remove('hidden');

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/${projectId}/membros`);
                const members = await response.json();

                if (members && members.length > 0) {
                    members.forEach(member => {
                        const li = document.createElement('li');
                        li.textContent = `${member.memberName} (ID: ${member.memberId})`;
                        allocatedMembersList.appendChild(li);
                    });
                    listMembersMessage.textContent = '';
                } else {
                    allocatedMembersList.innerHTML = '<li class="text-gray-500">Nenhum membro alocado.</li>';
                    listMembersMessage.textContent = '';
                }
            } catch (error) {
                listMembersMessage.textContent = `Erro ao carregar membros: ${error.message}`;
                listMembersMessage.classList.add('text-red-600');
            }
        }
    });

    // Fechar Modal de Listagem de Membros Alocados
    closeListMembersModalBtn.addEventListener('click', () => {
        listMembersModal.classList.add('hidden');
    });


    // --- Funções Utilitárias ---
    function formatDate(dateString) {
        // Converte 'YYYY-MM-DD' para 'DD/MM/YYYY'
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    // Inicializa a aplicação
    document.addEventListener('DOMContentLoaded', () => {
        // A aplicação começa sempre na tela de login
        showLoginScreen();
    });
</script>
</body>
</html>
